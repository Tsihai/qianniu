# 千牛客服自动化系统 - 项目开发文档

## 项目概述

千牛客服自动化系统是一个基于WebSocket的实时通信系统，用于自动处理千牛平台上的客户咨询消息，提高客服效率和用户体验。

## 项目结构

```
qianniu-service/
├── src/
│   ├── config/              # 配置文件
│   ├── services/            # 核心服务模块
│   │   ├── websocketService/  # WebSocket通信服务
│   │   ├── messageProcessor/  # 消息处理模块
│   │   └── businessLogic/     # 业务逻辑处理模块
│   ├── utils/               # 工具函数
│   ├── routes/              # API路由
│   └── index.js             # 主入口文件
├── tests/                   # 测试文件
└── package.json             # 项目依赖
```

## 核心模块

### 已完成模块

- **通信模块**：WebSocket服务，支持实时通信
  - 状态：✅ 已完成
  - 主要文件：`src/services/websocketService/index.js`
  - 功能：客户端连接管理、消息分发、心跳检测

- **消息处理**：自然语言处理模块
  - 状态：✅ 已完成
  - 主要文件：`src/services/messageProcessor/`
  - 功能：消息解析、意图识别、回复推荐

- **业务逻辑**：业务流程处理模块
  - 状态：✅ 已完成
  - 主要文件：`src/services/businessLogic/`
  - 功能：自动回复策略、统计分析、客户行为分析

### 待开发模块

- **数据存储**：数据持久化模块
  - 状态：⏳ 开发中
  - 主要文件：`src/services/dataStorage/`
  - 功能：消息历史、客户信息、统计数据的存储和检索

- **管理界面**：Web管理控制台
  - 状态：⏳ 开发中
  - 主要文件：`src/public/`
  - 功能：实时监控、规则配置、数据分析

## 开发日志

### 2025-07-10

#### 业务逻辑模块开发完成

今天完成了业务逻辑模块的开发，该模块负责连接消息处理和数据存储，实现核心业务功能。

**主要实现功能**：

1. **自动回复策略**：
   - 基于规则的自动回复系统
   - 支持多种回复模式：完全自动、建议回复、混合模式
   - 模板变量替换，支持个性化回复
   - 规则管理和持久化

2. **统计分析**：
   - 全局消息和会话统计
   - 意图分布和关键词统计
   - 时段分析（小时和日粒度）
   - 自动数据保存和加载

3. **客户行为分析**：
   - 客户行为特征识别
   - 个性化交互推荐
   - 客户资料管理
   - 历史交互记录

**技术要点**：

- 采用策略模式设计，将不同业务功能解耦
- 基于事件驱动的业务流处理
- JSON格式数据持久化
- 会话状态管理
- 实时数据统计和分析

**遇到的问题与解决方案**：

1. **问题**：规则匹配性能问题
   **解决**：优化正则表达式，减少不必要的全文匹配

2. **问题**：客户资料内存占用过大
   **解决**：实现自动清理过期会话机制，控制内存使用

3. **问题**：JSON数据持久化的并发安全
   **解决**：引入定时保存机制，减少IO操作频率

**后续优化方向**：

1. 引入更复杂的NLP模型，提高意图识别准确率
2. 增加机器学习算法，实现回复内容的自动生成
3. 添加更多可视化统计图表，便于分析数据
4. 优化持久化机制，考虑使用数据库替代文件存储

### 2025-07-09

#### 消息处理模块开发完成

今天完成了消息处理模块的开发，该模块负责对接收到的消息进行自然语言处理。

**主要实现功能**：

1. **消息解析器**：
   - 提取消息中的关键信息
   - 清洗消息内容
   - 提取关键词和实体

2. **意图分类器**：
   - 基于TF-IDF的文本向量化
   - 意图匹配和评分
   - 多意图识别

3. **回复推荐器**：
   - 基于意图的回复模板
   - 相似度计算
   - 多样化回复生成

**技术要点**：

- 使用自然语言处理库进行中文分词和关键词提取
- 文本向量化和相似度计算
- 配置驱动的回复模板系统

**遇到的问题与解决方案**：

1. **问题**：中文分词准确率不高
   **解决**：调整分词词典和参数，针对特定领域进行优化

2. **问题**：TF-IDF初始化问题导致意图识别不准确
   **解决**：修改初始化流程，确保在添加文档前正确设置

3. **问题**：JSON文件编码问题导致回复模板加载失败
   **解决**：添加默认回复机制，确保即使配置文件有问题也能正常工作

### 2025-07-08

#### 通信模块开发完成

今天完成了WebSocket通信模块的开发，该模块负责实现客户端与服务器之间的实时通信。

**主要实现功能**：

1. **连接管理**：
   - 客户端连接建立和断开处理
   - 客户端身份标识
   - 连接状态监控

2. **消息处理**：
   - 消息接收和解析
   - 消息分发
   - 消息发送和广播

3. **心跳检测**：
   - 定期心跳包
   - 连接状态检测
   - 自动重连机制

**技术要点**：

- 使用ws库实现WebSocket服务器
- 事件驱动架构
- 异步消息处理

**遇到的问题与解决方案**：

1. **问题**：WebSocket连接不稳定
   **解决**：实现心跳检测机制，定期检查连接状态

2. **问题**：消息处理性能瓶颈
   **解决**：使用异步处理和消息队列，避免阻塞主线程

3. **问题**：客户端断开连接后资源未释放
   **解决**：完善连接关闭处理逻辑，确保资源正确释放

## 测试情况

### 单元测试

- 通信模块：✅ 通过
- 消息处理模块：✅ 通过
- 业务逻辑模块：✅ 通过

### 集成测试

- 通信+消息处理：✅ 通过
- 消息处理+业务逻辑：✅ 通过
- 完整流程测试：⏳ 进行中

## 下一步计划

1. 开发数据存储模块，实现数据持久化
2. 设计和实现管理界面
3. 进行系统压力测试和性能优化
4. 完善文档和使用说明 