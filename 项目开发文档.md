# 千牛客服自动化项目开发文档

## 1. 项目概述

### 1.1 项目背景
本项目旨在借鉴SaiNiuApi框架的设计理念，开发一个轻量级的千牛客服自动化系统，实现买家咨询消息的实时捕获与分类处理，提升客服效率。

### 1.2 功能目标
- 实时捕获买家咨询消息
- 自动分类消息内容和意图
- 提供快速回复建议
- 数据统计与分析功能
- 模块化设计，便于扩展

### 1.3 技术选型
- **核心技术栈**：Node.js + WebSocket + Express
- **前端框架**：React 
- **数据存储**：本地文件存储/SQLite
- **消息处理**：自然语言处理模块
- **开发环境**：Windows 11

## 2. 系统架构

### 2.1 整体架构
系统采用模块化设计，主要包含以下几个部分：
1. 通信模块：负责与千牛客户端的数据交互
2. 消息处理模块：负责消息的分析与分类
3. 业务逻辑模块：实现核心业务功能
4. 数据存储模块：管理系统数据
5. 用户界面模块：提供操作交互界面

### 2.2 数据流向
1. 千牛API接收买家消息
2. 通信模块获取消息内容
3. 消息处理模块进行分析分类
4. 业务逻辑模块处理业务流程
5. 数据存储模块记录相关信息
6. 用户界面模块展示处理结果

## 3. 技术原理与实现

### 3.1 WebSocket通信实现
系统使用WebSocket技术实现与千牛客户端的实时通信，保证消息的即时性与可靠性。WebSocket服务将作为系统的核心通信组件，处理消息的接收与发送。

```javascript
const WebSocket = require('ws');
const wss = new WebSocketServer({ port: 8080 });

wss.on('connection', function connection(ws) {
  ws.on('error', console.error);

  ws.on('message', function message(data) {
    // 处理接收到的消息
    console.log('received: %s', data);
    
    // 消息处理逻辑
    processMessage(data);
  });

  // 发送响应
  function sendResponse(content) {
    ws.send(JSON.stringify(content));
  }
});
```

### 3.2 消息处理机制
1. **消息解析**：将接收的原始数据转换为系统可处理的格式
2. **内容分析**：提取关键词和语义信息
3. **意图识别**：判断买家咨询的主要目的
4. **自动分类**：按预设规则对消息进行分类
5. **回复推荐**：根据分类结果推荐合适的回复模板

### 3.3 数据存储方案
初期采用本地文件存储或SQLite数据库，主要存储：
1. 历史消息记录
2. 分类规则配置
3. 回复模板库
4. 统计数据信息

## 4. 开发路线图

### 4.1 MVP阶段（第一阶段）
- 实现基本的WebSocket通信功能
- 消息接收与发送的核心功能
- 简单的消息分类规则
- 基础界面展示

### 4.2 增强阶段（第二阶段）
- 完善消息处理算法
- 增加自定义分类规则
- 优化回复推荐系统
- 增强数据统计功能

### 4.3 完善阶段（第三阶段）
- 实现高级分析功能
- 添加自动回复模式
- 优化用户体验
- 系统性能调优

## 5. 开发与测试计划

### 5.1 开发环境搭建
1. Node.js开发环境配置 - **已完成**
2. 千牛API接入准备 - **进行中**
3. 开发工具链准备 - **已完成**

### 5.2 模块开发计划
1. 通信模块（2天）- **已完成**
2. 消息处理模块（3天）- **已完成**
3. 业务逻辑模块（4天）- 未开始
4. 数据存储模块（2天）- 未开始
5. 用户界面模块（5天）- 未开始

### 5.3 测试策略
1. 单元测试：各模块功能测试
2. 集成测试：模块间交互测试
3. 系统测试：整体功能测试
4. 性能测试：高并发场景测试

## 6. 安全与合规性

### 6.1 数据安全
1. 消息内容加密存储
2. 敏感信息脱敏处理
3. 定期数据备份机制

### 6.2 合规要求
1. 遵循千牛开放平台规范
2. 符合数据隐私保护要求
3. 合规的API调用方式

## 7. 部署与维护

### 7.1 部署方案
1. 本地部署：直接在商家电脑上运行
2. 服务器部署：部署在云服务器上（后期考虑）

### 7.2 维护计划
1. 定期功能更新
2. Bug修复与性能优化
3. 数据备份与恢复策略

## 8. 项目进度跟踪

| 模块 | 计划完成时间 | 实际完成时间 | 完成状态 |
|-----|------------|------------|--------|
| 通信模块 | 2025/7/12 | 2025/7/10 | ✅ 已完成 |
| 消息处理模块 | 2025/7/15 | 2025/7/10 | ✅ 已完成 |
| 业务逻辑模块 | 2025/7/19 | - | 未开始 |
| 数据存储模块 | 2025/7/21 | - | 未开始 |
| 用户界面模块 | 2025/7/26 | - | 未开始 |

## 9. 资源与参考

### 9.1 技术资源
- Node.js文档: https://nodejs.org/docs/latest/api/
- WebSocket库文档: https://github.com/websockets/ws
- 千牛开放平台文档: https://open.taobao.com/doc.htm

### 9.2 参考项目
- SaiNiuApi框架设计
- 现代客服自动化系统架构

## 10. 模块开发记录

### 10.1 通信模块（2025/7/10 已完成）

#### 实现功能
- WebSocket服务器创建与配置
- 客户端连接管理
- 消息接收与发送
- 心跳检测机制
- 错误处理与连接恢复
- 通信协议设计与实现
- 测试客户端工具开发

#### 目录结构
```
qianniu-service/
├── src/
│   ├── config/        # 配置文件
│   ├── controllers/   # 控制器 (预留)
│   ├── models/        # 数据模型 (预留)
│   ├── services/      # 服务层
│   │   └── websocketService.js  # WebSocket服务实现
│   ├── utils/         # 工具函数
│   │   └── wsClient.js  # 测试客户端
│   └── index.js       # 主入口文件
├── .env               # 环境配置
├── package.json
└── README.md
```

#### 技术要点
- 使用ws库实现WebSocket服务器
- 客户端唯一标识与会话管理
- JSON格式消息协议
- 心跳检测保证连接稳定性
- Express REST API提供系统管理
- 自动重连机制增强可靠性

#### 后续优化方向
- 添加消息加密机制
- 增强连接认证安全性
- 优化高并发连接处理能力
- 实现消息持久化存储

### 10.2 消息处理模块（2025/7/10 已完成）

#### 实现功能
- 消息解析与预处理
- 关键词提取与分析
- 基于规则的意图识别
- 基于机器学习的分类器
- 回复推荐系统
- 会话状态管理
- 测试与集成

#### 目录结构
```
qianniu-service/
├── src/
│   ├── services/
│   │   ├── messageProcessor/
│   │   │   ├── data/
│   │   │   │   ├── intents.json      # 意图定义数据
│   │   │   │   ├── replies.json      # 回复模板数据
│   │   │   │   └── stopwords.json    # 停用词数据
│   │   │   ├── index.js              # 消息处理主模块
│   │   │   ├── MessageParser.js      # 消息解析器
│   │   │   ├── IntentClassifier.js   # 意图分类器
│   │   │   └── ReplyRecommender.js   # 回复推荐器
│   ├── tests/
│   │   └── messageProcessor.test.js  # 消息处理测试
```

#### 技术要点
- 使用Natural.js进行自然语言处理
- 使用nodejieba进行中文分词
- TF-IDF算法提取关键词
- 基于模式匹配的意图识别
- 朴素贝叶斯分类器
- 基于模板的回复生成
- 会话状态跟踪与管理

#### 后续优化方向
- 优化意图识别准确率
- 增加更多分类算法
- 支持自定义分类规则
- 实现上下文相关的回复
- 添加学习能力，不断优化分类效果
- 解决中文编码问题 